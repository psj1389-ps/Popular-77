<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF → XLS 변환기</title>
    <style>
        body{font-family:Arial;background:#f5f5f5;margin:0;padding:0}
        
        /* 🔥 상단 그라디언트 헤더 영역 */
        .gradient-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 20px;
            position: relative;
            overflow: hidden;
        }
        
        .gradient-header::before {
            content: '';
            position: absolute;
            inset: 0;
            opacity: 0.3;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="12" cy="8" r="0.6" fill="%23ffffff" opacity="0.18"/><circle cx="37" cy="23" r="1.8" fill="%23ffffff" opacity="0.06"/><circle cx="68" cy="15" r="0.9" fill="%23ffffff" opacity="0.14"/><circle cx="91" cy="42" r="1.3" fill="%23ffffff" opacity="0.09"/><circle cx="24" cy="56" r="0.7" fill="%23ffffff" opacity="0.16"/><circle cx="55" cy="73" r="1.5" fill="%23ffffff" opacity="0.07"/><circle cx="83" cy="88" r="1.1" fill="%23ffffff" opacity="0.11"/><circle cx="6" cy="34" r="2.0" fill="%23ffffff" opacity="0.05"/><circle cx="45" cy="47" r="0.8" fill="%23ffffff" opacity="0.13"/><circle cx="72" cy="61" r="1.2" fill="%23ffffff" opacity="0.10"/><circle cx="18" cy="79" r="0.5" fill="%23ffffff" opacity="0.19"/><circle cx="63" cy="29" r="1.7" fill="%23ffffff" opacity="0.08"/><circle cx="89" cy="18" r="0.9" fill="%23ffffff" opacity="0.15"/><circle cx="31" cy="91" r="1.4" fill="%23ffffff" opacity="0.12"/><circle cx="76" cy="5" r="0.6" fill="%23ffffff" opacity="0.17"/><circle cx="9" cy="67" r="1.6" fill="%23ffffff" opacity="0.06"/><circle cx="52" cy="12" r="1.0" fill="%23ffffff" opacity="0.14"/><circle cx="95" cy="76" r="0.8" fill="%23ffffff" opacity="0.11"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>') repeat;
            animation: float 20s ease-in-out infinite;
        }
        
        @keyframes float {
            0% { transform: translateX(0px) translateY(0px); }
            33% { transform: translateX(-25px) translateY(18px); }
            66% { transform: translateX(22px) translateY(-15px); }
            100% { transform: translateX(0px) translateY(0px); }
        }
        
        .header-content {
            position: relative;
            z-index: 10;
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }
        
        /* 🔥 아이콘과 텍스트를 가로로 배치 */
        .title-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .logo-icon {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }
        
        .main-title {
            font-size: 2.8em;
            font-weight: bold;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .main-subtitle {
            font-size: 1.3em;
            opacity: 0.9;
            margin: 0;
            font-weight: 300;
            line-height: 1.4;
        }
        
        /* 🔥 화이트 메인 컨테이너 */
        .main-container {
            background: white;
            max-width: 800px;
            margin: 0 auto;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            min-height: calc(100vh - 300px);
        }
        
        .container-content {
            padding: 40px;
        }
        
        .content-section {
            background: #f8f9fa;
            color: #333;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .section-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.8em;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .section-subtitle {
            font-size: 1.1em;
            color: #666;
            margin: 0;
        }
        
        .upload-area{border:2px dashed #ddd;padding:40px;text-align:center;border-radius:10px;cursor:pointer;margin-top:20px}
        .upload-area:hover{border-color:#667eea;background:#f8f9ff}
        .file-input{display:none}
        .btn{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-size:16px;transition:all 0.3s ease}
        .btn:hover{background:linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);transform:translateY(-2px)}
        .btn:disabled{background:#6c757d;cursor:not-allowed;transform:none}
        .file-info{background:#f8f9fa;padding:15px;border-radius:8px;margin-top:15px;display:none}
        .quality-options{margin:15px 0;display:none}
        .quality-options label{display:block;margin:8px 0;cursor:pointer}
        .error{background:#f8d7da;color:#721c24;padding:12px;border-radius:8px;margin-top:10px;display:none}
        .success{background:#d4edda;color:#155724;padding:12px;border-radius:8px;margin-top:10px;display:none}
        .loading{display:none;text-align:center;margin-top:20px}
        .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .reset-btn{background:#6c757d;margin-left:10px}
        .reset-btn:hover{background:#545b62;transform:translateY(-2px)}
        .button-group{display:flex;justify-content:center;gap:10px;margin-top:20px}
        
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .title-row {
                flex-direction: column;
                gap: 15px;
            }
            .main-title { 
                font-size: 2.2em; 
            }
            .main-subtitle {
                font-size: 1.1em;
            }
            .container-content {
                padding: 20px;
            }
            .content-section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Flash 메시지 표시 영역 -->
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-warning" role="alert" style="margin: 20px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; color: #856404; font-weight: 500;">
          {% for message in messages %}
            <div style="margin-bottom: 5px;">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- 🔥 상단 그라디언트 헤더 -->
    <div class="gradient-header">
        <div class="header-content">
            <!-- 아이콘과 텍스트를 가로로 배치 -->
            <div class="title-row">
                <div class="logo-icon">📈</div>
                <h1 class="main-title">PDF → XLS 변환기</h1>
            </div>
            <p class="main-subtitle">PDF 파일을 Excel 파일로 쉽게 변환하세요.</p>
        </div>
    </div>
    
    <!-- 🔥 화이트 메인 컨테이너 -->
    <div class="main-container">
        <div class="container-content">
            <!-- 콘텐츠 섹션 -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">PDF → XLS 변환기</h2>
                    <p class="section-subtitle">안정적인 스프레드시트 변환</p>
                </div>
                
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="upload-area" id="uploadArea">
                        <div id="uploadText">
                            <h3>파일을 선택하세요</h3>
                            <p>PDF 파일을 클릭하여 선택 (최대 100MB)</p>
                        </div>
                        <input type="file" id="fileInput" class="file-input" accept=".pdf">
                    </div>
                </form>
                
                <div class="file-info" id="fileInfo">
                    <div id="fileName"></div>
                    <div id="fileSize"></div>
                    
                    <div class="quality-options" id="qualityOptions">
                        <h4>변환 품질 선택:</h4>
                        <label><input type="radio" name="quality" value="low" checked> 빠른 변환 (권장)</label>
                        <label><input type="radio" name="quality" value="medium"> 표준 변환</label>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn" id="convertBtn" onclick="convertFile()">변환하기</button>
                        <button class="btn reset-btn" id="resetBtn" onclick="resetFile()">파일 초기화</button>
                    </div>
                </div>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>변환 중입니다... 잠시만 기다려주세요.</p>
                </div>
                
                <div class="error" id="errorMsg"></div>
                <div class="success" id="successMsg"></div>
            </div>
        </div>
    </div>



    <script>
        let selectedFile = null;

        document.getElementById('uploadArea').addEventListener('click', function(e) {
            if (e.target.tagName.toLowerCase() !== 'input') {
                document.getElementById('fileInput').click();
            }
        });

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // 파일 크기 체크
                if (file.size > 100 * 1024 * 1024) {
                    showError(`파일 크기가 너무 큽니다: ${(file.size/1024/1024).toFixed(1)}MB (최대 100MB)`);
                    return;
                }
                
                selectedFile = file;
                document.getElementById('fileName').textContent = `파일명: ${file.name}`;
                document.getElementById('fileSize').textContent = `크기: ${(file.size/1024/1024).toFixed(2)}MB`;
                document.getElementById('fileInfo').style.display = 'block';
                
                // PDF 파일인 경우에만 품질 옵션 표시
                if (file.name.toLowerCase().endsWith('.pdf')) {
                    document.getElementById('qualityOptions').style.display = 'block';
                } else {
                    document.getElementById('qualityOptions').style.display = 'none';
                }
                
                hideMessages();
            }
        });

        async function convertFile() {
            if (!selectedFile) return;
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            
            // 품질 설정 추가
            const quality = document.querySelector('input[name="quality"]:checked')?.value || 'low';
            formData.append('quality', quality);
            
            // UI 업데이트
            document.getElementById('convertBtn').disabled = true;
            document.getElementById('convertBtn').textContent = '변환 중...';
            document.getElementById('loading').style.display = 'block';
            hideMessages();
            
            try {
                console.log('변환 요청 시작:', selectedFile.name, '품질:', quality);
                
                const response = await fetch('/convert', {
                    method: 'POST',
                    body: formData
                });
                
                // 🔥 Content-Type 기반 응답 처리
                const contentType = response.headers.get('Content-Type') || '';
                console.log('응답 Content-Type:', contentType);
                
                if (!response.ok) {
                    // 오류 응답 처리 - Content-Type 확인
                    if (contentType.includes('application/json')) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || '변환 실패');
                    } else {
                        const errorText = await response.text();
                        throw new Error(errorText || `HTTP ${response.status}: ${response.statusText}`);
                    }
                }
                
                // 성공 응답 처리
                if (contentType.includes('application/json')) {
                    // JSON 응답 처리
                    const jsonData = await response.json();
                    
                    if (jsonData.success && jsonData.download_url) {
                        // 다운로드 URL이 있는 경우 다운로드 실행
                        const downloadUrl = jsonData.download_url;
                        const a = document.createElement('a');
                        a.href = downloadUrl;
                        a.download = selectedFile.name.replace(/\.[^/.]+$/, '.xlsx');
                        
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        showSuccess(`변환 완료! ${a.download} 파일이 다운로드됩니다.`);
                    } else {
                        // 일반 메시지 응답
                        showSuccess(jsonData.message || '변환이 완료되었습니다.');
                    }
                } else {
                    // 파일 다운로드
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = selectedFile.name.replace(/\.[^/.]+$/, '.xlsx');
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    URL.revokeObjectURL(url);
                    
                    showSuccess(`변환 완료! ${a.download} 파일이 다운로드됩니다.`);
                }
                
            } catch (error) {
                console.error('변환 오류:', error);
                showError(error.message || '변환 중 오류가 발생했습니다.');
            } finally {
                // UI 복원
                document.getElementById('convertBtn').disabled = false;
                document.getElementById('convertBtn').textContent = '변환하기';
                document.getElementById('loading').style.display = 'none';
            }
        }

        function resetFile() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('qualityOptions').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('convertBtn').disabled = false;
            document.getElementById('convertBtn').textContent = '변환하기';
            
            // 품질 설정 초기화
            document.querySelector('input[name="quality"][value="low"]').checked = true;
            
            hideMessages();
        }

        function showError(msg) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = msg;
            errorDiv.style.display = 'block';
            document.getElementById('successMsg').style.display = 'none';
        }

        function showSuccess(msg) {
            const successDiv = document.getElementById('successMsg');
            successDiv.textContent = msg;
            successDiv.style.display = 'block';
            document.getElementById('errorMsg').style.display = 'none';
        }

        function hideMessages() {
            document.getElementById('errorMsg').style.display = 'none';
            document.getElementById('successMsg').style.display = 'none';
        }
    </script>
</body>
</html>