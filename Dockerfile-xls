FROM python:3.12-slim

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PIP_NO_CACHE_DIR=1
ENV PIP_ROOT_USER_ACTION=ignore
ENV SAL_USE_VCL=svp
ENV OOO_DISABLE_RECOVERY=1

RUN apt-get update && apt-get install -y --no-install-recommends libreoffice-calc fonts-liberation fonts-noto-cjk && apt-get clean && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY services/xls-pdf/requirements.txt /tmp/requirements.txt
RUN python -m pip install --upgrade pip && pip install --no-cache-dir -r /tmp/requirements.txt
COPY services/xls-pdf/ /app/

CMD ["sh","-c","python -m gunicorn app:app -b 0.0.0.0:${PORT:-10000} -k sync -w 1 --threads 1 --timeout 600 --graceful-timeout 30 --keep-alive 15 --max-requests 200 --max-requests-jitter 40 --worker-tmp-dir=/dev/shm"]